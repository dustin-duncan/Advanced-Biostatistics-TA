---
title: "lab_5_completed"
author: "Dustin Duncan"
date: "2024-02-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(rethinking)
rm(list = ls())
```
# Bayesian Statistical Modeling Winter 2024
# Lab Exercise, Week 6

*When is this lab due?* Labs are due on the Thursday after they are assigned. However, in many cases you can complete them during the lab period itself.   This assignment is due on Thursday, 2/22/2024.  

## Remember Hydroxychloroquine?
Hydroxychloroquine had a few news cycles last spring. Following the first news that it might benefit hospitlized covid patients, an early trial on patients in the hospital with covid was realeased  ( full data here: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7556078/). 

They had patients who either received no drug treatment, received Hydroxychloroquine, or Hydroxychloroquine+Azithromycin. The results were

no drugs: 18 died, 140 discharged 
HC : 27 died, 70 discharged
HC+AZ: 25 died, 88 discharged. 

Your goal is to create a model that will allow you to assess the affect of the drug. To do this, we will want to create multiple models that differ in how many parameters they have. The "simplest" model should have one parameter describing the probability of death/discharge for all patients, regardless of drug treatment. 
More complex models can have distinct effects of having HC or AZ. 

## Creating our dataframe 

```{r}
covid <- tibble(group = c(1, 2, 3), drug = c(1, 2, 2), treatment = c("ND", "HC", "HCAZ"), deaths = c(18, 27, 25), discharge = c(140, 70, 88), total = c(158, 97, 113))
```



Write out your model in statistical notation, with priors, before computing it. One important techique for computing the model is to note that you can use `(x==i)` type statements within `quap` to determine which parameter gets applied. This works better than `theta[group]` type statements.

Once you have your models, compare them using WAIC.

1. No drug or treatment 
2. Either yes drug or no drug 
3. Just effect of treatment
4. Adding both treatment and which drug

## Writing Simplest model 

**Here we are just finding the probability of death based on the total patients**

$$
\text{Simplest case, no predictors} \\
\mathrm{deaths} \sim \mathrm{Binomial(Total_i , \mu_i)} \\
\mu_i \sim \mathrm{Uniform(0, 1)}
$$

Putting our model int quap
```{r}
m.simp <- quap(
  alist(
    deaths ~ dbinom(total, mu),
    mu ~ dunif(0, 1)
  ), data = covid
)
precis(m.simp,depth = 2)

sum(covid$total)
sum(covid$deaths)
70/386
```

With just comparing the deaths versus discharges, we can see that the likelihood of death is 19%. 

Extracting samples 
```{r}
samples.simp <- extract.samples(m.simp) %>% as_tibble()
bayesplot::mcmc_intervals(samples.simp, prob=0.8, prob_outer = 0.95)
```

## Now looking at whether or not they received a drug 

```{r}
m.drug <- quap(
  alist(
    deaths ~ dbinom(total, mu[drug]),
    mu[drug] ~ dunif(0, 1)
  ), data = covid
)
precis(m.drug, depth = 2)
```

Here we can see that those that received a drug had a 25% chance of death, wehreas those that did not had 11% chance of death. 

Could this be because we didnt standardize?

Lets find out 
```{r}
# covid$D <- standardize(covid$deaths) # D for dead
# covid$R <- standardize(covid$discharge) # R for release
# covid$T <- standardize(covid$total)
```

## Now looking at the treatment alone 

```{r}
m.treat <- quap(
  alist(
    deaths ~ dbinom(total, mu[group]),
    mu[group] ~ dunif(0,1)
  ), data = covid
)
precis(m.treat, depth = 2)
# inv_logit(-1.437)
# inv_logit(1.59)
# inv_logit(-5.29)
# x1 = rep(0, times=18)
# x2 = rep(1, times=140)
# x3 = rep(0, times = 27)
# x4 = rep(1, times = 70)
# x5 = rep(0, times = 25)
# x6 = rep(1, times = 88)
# t1 = rep("no_drug", times = 140+18)
# t2 = rep("HC", times = 70+27)
# t3 = rep("HCAZ", times = 25+88)
# outcome <- c(x1, x2, x3, x4, x5, x6)
# treatment <- c(t1, t2, t3)
# d = data.frame(treatment, outcome)
```

We can see that there is a slight difference between HC and AZ

```{r}
compare(m.simp, m.drug, m.treat, func = WAIC)
```

## Alternative model formulation
Instead of setting distinct parameters for the groups, you could also choose to set a global mean parameter and then model the difference from that. Something like this:
`y ~ dnorm(mu,sigma),`
`mu <- a + (group==1)*deltamu  - (group==2)*deltamu`


Once you have the `quap` object, you can then use `mutate` to convert back to the group-specific mean values. 